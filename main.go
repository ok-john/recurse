package main

import (
	"context"
	"log"
	"net/http"
	"net/url"
	"strings"

	"github.com/ca-std/lib"
	"github.com/go-redis/redis/v8"
)

const (
	REDIS_ADDR = "trusted.recurse:6379"
	HTTP_ADDR  = "recurse:443"
	CERT       = "/etc/letsencrypt/live/1o.fyi/fullchain.pem"
	PK         = "/etc/letsencrypt/live/1o.fyi/privkey.pem"
	ART        = "ICAgKiAgIC4gICAgICAgICAgICAgICAgICAuICAgICAgICAgICAgICAuICAgICAgICAuICAgICAgICAuICAgICAgIC4gICAgICAgICAgICAgICAgCi4gICAgICAgICAuICAgICAgICAgICAgICAgICAgICAgLiAgICAgICAuICAgICAgICAgICAuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICBvICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuICAgICAgICAgICAgICAuICAgICAgICAgICcgICAgICAgICAgICAgCiAgICAgICAgMCAgICAgLiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAuICAgICAgICAgIC4gICAgICAgICAgICAgICAgICwgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgIFwgICAgICAgICAgLiAgICAgICAgICAgICAgICAgICAgICAgICAuICAgICAgICAgICAgICAgICAqICAgICAgICAgICAgICAgICAgCiAgICAuICAgICAgXCAgICwgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogLiAgICAgICAgICBvICAgICAuICAgICAgICAgICAgICAgICAuICAgICAgICAgICAgICAgICAgIC4gICAgICAgICAgICAgICAgLiAgICAgICAgICAKICAgLiAgICAgICAgIFwgICAgICAgICAgIHcgICBlICAgbCAgIGMgICBvICAgbSAgIGUgICAgICAuICAsICAgLiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgbyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgI1wjI1wjICAgICAgLiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLiAgICAgICAgLiAgICAgICAgICAgICAgICAKICAgICAgICAgICAjICAjTyMjXCMjIyAgICAgICAgICAgICAgICAuICAgICAgICAgICAgICAgICAgICAgICAgICAuICAgICAgICAgICAgICAgICAgCiAuICAgICAgICAjKiMgICNcIyNcIyMjICAgICAgICAgICAgICAgICAgICAgICAuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAuICAgIyMqIyAgI1wjI1wjIyAgICAgICAgICAgIC4gICAgICAgICAgICAgICAgICAuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgIC4gICAgICAjIyojICAjbyMjXCMgICAgICAgICAuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICwgICAgICAgLiAgICAgICAgICAgCiAgICAgICAgLiAgICAgKiMgICNcIyAgICAgLiAgICAgICAgICAgICAgICAgICAgLiAgICAgICAgICAgICAgIC4gICAgICAgICAgLCAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIFwgICAgICAgICAgLiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKX19eL1xfX19eLS1fX19fL1xfX19fT19fX19fX19fX19fX19fL1wvXC0tLS9cX19fIF9fX19eX19fX19fX19fX19fXy9cL1wtLS0vXF9fX19fX19fCiAvXF4gICBeICBeICAgIF4gICAgICAgICAgICAgICAgICBeXiBeICAnXCBeICAgICAgICAgICAgICAgIF4gICAgICAgLS0tICAgICAgICAgICAgIAogICAgICAgLS0gICAgICAgICAgIC0gICAgICAgICAgICAtLSAgLSAgICAgIC0gICAgICAgICAgICAgICAgLS0tICBfXyAgICAgICBeICAgICAgICAKIC0tICBfXyAgICAgICAgICAgICAgICAgICAgICBfX18tLSAgXiAgXiAgICAgICAgICAgJyAgICAgICAgICAgICAgICAgICAgIC0tICBfXyAgICAgCiAgICAgICAgICAgICAgICAgICAgLS0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvXCAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF8rJyIiLS4gICAgICAgICAKICAgICAgICAgICAgICAgIGAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0gICAgICAgICAgICAgICBfLi0tLScgICAgICAgIC0gICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0tICAgICAgICBfLSctLS4gICAgICAgICAgICBgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC4nICAgICAgYC0gICAgICBgICAgICBgICAgICAKICAgLSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkgICAgICAgICAgICBcICAgIC4nICAgJyAgICAgYCAgICAgICAgICAgICBgICAgCiAgICAgICAgICAgICAgIC8vICAgICAgICAgICAgICggICAgKCAgICAgIC0tICAgICAgICAgIGAtLiAgJy98ICAgICBgICAgYCAgICAgICAgYCAgIApfXyAgICAgICAgICAgICgnPiAgICAgICAgICAgICAgKSAvXCAgICAgICAgICAgICAgICAgICAgICBgLTwgfCAgJyAgIGAgICAgICAgICAgICAgXCAKICAgICAgICAgICAgICAvcnIgICAgICAgICAgICAoICAvLyB8ICggICAgICAgICAgICAgICAgICAgICAgIGArLiAgICAgIGAgICAgICBgICAgICBMCiAgICAgICAgICAgICAqXCkpXyAgICAgICAgIF8gLS47Xy8gXFwtLS5fICAgICAgICAgICAgICAgICAgICAgIGAtLiAgICBKICAgICAgIF8uLSAnIAogICAgICAgICAgICAgICAgICAgICAgICAgIChfOy0vLyB8IFwgXC0nLlwgICAgICAgICAgICAgICAgICAgICAgICBgLS4gIEwgIF8uLScgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAoIGAuX18gXyAgX19fLCcpICAgL1wgICAgICAgICAgICAgICAgICAgICAgYC18LScgICAgLS0gICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgIGAnKF8gKV8pKF8pXyknICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAoK"
)

var (
	instance = context.Background()
	client   = redis.NewClient(&redis.Options{
		Addr: REDIS_ADDR,
	})
)

func main() {
	defer instance.Done()
	mux := http.NewServeMux()
	mux.HandleFunc("/", home)
	mux.HandleFunc("/get", get)
	mux.HandleFunc("/set", set)
	server := &http.Server{
		Addr:    HTTP_ADDR,
		Handler: mux,
	}
	log.Fatal(server.ListenAndServeTLS(CERT, PK))
}

func home(w http.ResponseWriter, req *http.Request) {
	w.Header().Add("Strict-Transport-Security", "max-age=63072000")
	w.Write(<-lib.DecodeBase64([]byte(ART)))
}

func set(w http.ResponseWriter, req *http.Request) {
	for key, value := range parseUri(req.URL) {
		response, _ := client.Set(context.TODO(), key, value, 0).Result()
		w.Write([]byte(response))
	}
}

func get(w http.ResponseWriter, req *http.Request) {
	for key := range parseUri(req.URL) {
		response, _ := client.Get(context.TODO(), key).Result()
		w.Write([]byte(response))
	}
}

func parseUri(u *url.URL) map[string]string {
	uri, res := u.RawQuery, make(map[string]string)
	pairs := strings.Split(uri, "?")
	for _, pair := range pairs {
		split := strings.Split(pair, "=")
		if len(split) == 1 {
			split = append(split, "")
		}
		res[split[0]] = split[1]
	}
	return res
}
